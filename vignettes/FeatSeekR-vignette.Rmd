---
title: "`FeatSeekR` user guide"
author: 
- name: Tuemay Capraz
  affiliation: European Molecular Biology Laboratory, Heidelberg
  email: tuemay.capraz@embl.de
package: FeatSeekR
date: "`r Sys.Date()`"
output:  
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{`FeatSeekR` user guide}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignettePackage{FeatSeekR-vignette}
    %\VignetteEncoding{UTF-8}
---



```{r setup, message=FALSE}
library(FeatSeekR)
library(DmelSGI)
library(resample)
library(pheatmap)
library(ggplot2)
```


# Introduction

A fundamental step in many analyses of high-dimensional data is dimension 
reduction. Feature selection is one approach to dimension reduction whose 
strengths include interpretability, conceptual simplicity, transferability 
and modularity.
Here, we introduce the FeatSeekR algorithm, which selects features based on 
the consistency of their signal across replicates and their non-redundancy.
It takes a 3 dimensional array (samples x features x replicates) 
or a list of replicate matrices/dataframes (samples x features)  as input 
and returns a dataframe storing the selected and ranked features and 
their replicate correlations.

# Installation

```{r, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("FeatSeekR")
```

# Selecting image features from the `DmelSGI` package

Here we use FeatSeekR to rapidly identify unique features with reproducible 
signal between measurements in an image dataset from the `DmelSGI` package. 
The authors of `DmelSGI` performed combinatorial gene knock-outs using siRNA, 
followed by imaging of the cells. The resulting images were segmented and 
features were extracted using the `EBImage` package. 

```{r, load_data}
# load data
data("subSampleForStabilitySelection", package="DmelSGI")
data <- subSampleForStabilitySelection$D
# make sure dimensions are samples x features x replicates
data <- aperm(data, c(1,3,2))
# set feature names
dimnames(data)[[2]] <- subSampleForStabilitySelection$phenotype
dim(data)
```

The input data is a 3 dimensional array with 3000 samples, 162 features and 2
replicates.

```{r plot data}
# plot correlation matrix of the first 100 features of one of the replicates
cor_mat <- cor(data[,1:100,1])
pheatmap(cor_mat, show_rownames = FALSE, show_colnames = FALSE,
    treeheight_row = 0, treeheight_col = 0)
```

When plotting the correlation matrix of the features, we can see that many 
features are highly correlated and form redundant feature clusters. We apply 
FeatSeek to identify unique features with high replicate consistency.

```{r select_features}
# select up to 50 features
max_features <- 50
res <- FeatSeek(data, max_features = max_features)
```

We can further refine the number of selected features by running get_opt on 
the result dataframe.

```{r refine_selection}
opt <- get_opt(res)
res_opt <- res[seq_len(opt),]

# subset data to selected features
Sdata <- data[,res_opt$selected,]

# plot correlation matrix of selected features of one of the replicates
cor_mat <- cor(Sdata[,,1])
pheatmap(cor_mat, show_rownames = FALSE, show_colnames = FALSE,
    treeheight_row = 0, treeheight_col = 0)
```

We evaluate the selected feature set by calculating the SVD entropy
and the reconstruction error. SVD entropy is a measure for redundancy, 
the higher the less redundant are the features of the data. 
We define the reconstruction error as the square root of the
frobenius norm when approximating the remaining by the selected features. It is 
therefore a measure of how well our selected set of features can represent the 
information present in the whole data. We compare the selected feature set to
the 50 features with highest variance.

```{r select_highvariance}
# get top 50 variance features from data averaged over replicates
data.mean <- apply(data, c(1,2), mean)
vars <- colVars(data.mean)
topidx <- sort(vars, index.return=TRUE, decreasing=TRUE)
var_res <- data.frame(selected=names(topidx$x)[seq_len(max_features)])
```

```{r, evaluate_features}
svd_entropy <- svd_entropy(data, res)
reconstruction_error <- reconstruction_error(data, res)

svd_entropy_var <- svd_entropy(data, var_res)
reconstruction_error_var <- reconstruction_error(data, var_res)

plot <- function(plotdf, metric, opt) {
    ggplot(plotdf, aes(x=Features)) + 
    geom_line(aes( y=FeatSeek, colour="FeatSeek"), size=1.2) +
    geom_line(aes( y=Variance, colour="Variance"), size=1.2) +
    geom_point(aes( y=FeatSeek, colour="FeatSeek"), size=2) +
    geom_point(aes( y=Variance, colour="Variance"), size=2) +
    geom_vline(xintercept=opt,linetype = "dashed")+
    scale_shape_manual("", breaks= c("FeatSeek", "Variance"), 
        values=c(4, 4), guide="none") +
    ylab(metric)  +
    xlab("Number of selected features")+
    scale_colour_manual("",
        breaks = c("FeatSeek", "Variance"),
        values = c("red",  "blue"))+
    theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size=16))
}

re_df <- data.frame(Features=seq_len(max_features), 
                    FeatSeek = unlist(reconstruction_error), 
                    Variance= unlist(reconstruction_error_var))
svd_df <- data.frame(Features=seq_len(max_features),  
                     FeatSeek = unlist(svd_entropy), 
                     Variance=unlist(svd_entropy_var))

plot(re_df, "Reconstruction error", opt)
plot(svd_df, "SVD entropy", opt)
```

# Session Info

```{r}
sessionInfo()
```

